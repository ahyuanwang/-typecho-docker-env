!function(b){function a(){var c={};return function(d){(function(j,l,h){var f=window.setTimeout;var k={};var n=l.core.utils;var m=l.runtime.Runtime;function i(r){var p=r.required_features,q={};function o(w,u,s){var v={chunks:"slice_blob",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",urlstream_upload:"send_binary_string",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};if(v[w]){q[v[w]]=u}else{if(!s){q[w]=u}}}if(typeof p==="string"){g.each(p.split(/\s*,\s*/),function(s){o(s,true)})}else{if(typeof p==="object"){g.each(p,function(u,s){o(s,u)})}else{if(p===true){if(r.chunk_size&&r.chunk_size>0){q.slice_blob=true}if(!g.isEmptyObj(r.resize)||r.multipart===false){q.send_binary_string=true}if(r.http_method){q.use_http_method=r.http_method}g.each(r,function(u,s){o(s,!!u,true)})}}}return q}var g={VERSION:"2.3.6",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,moxie:l,mimeTypes:n.Mime.mimes,ua:n.Env,typeOf:n.Basic.typeOf,extend:n.Basic.extend,guid:n.Basic.guid,getAll:function j(o){var e=[],q;if(g.typeOf(o)!=="array"){o=[o]}var p=o.length;while(p--){q=g.get(o[p]);if(q){e.push(q)}}return e.length?e:null},get:n.Dom.get,each:n.Basic.each,getPos:n.Dom.getPos,getSize:n.Dom.getSize,xmlEncode:function(q){var p={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},o=/[<>&\"\']/g;return q?(""+q).replace(o,function(r){return p[r]?"&"+p[r]+";":r}):q},toArray:n.Basic.toArray,inArray:n.Basic.inArray,inSeries:n.Basic.inSeries,addI18n:l.core.I18n.addI18n,translate:l.core.I18n.translate,sprintf:n.Basic.sprintf,isEmptyObj:n.Basic.isEmptyObj,hasClass:n.Dom.hasClass,addClass:n.Dom.addClass,removeClass:n.Dom.removeClass,getStyle:n.Dom.getStyle,addEvent:n.Events.addEvent,removeEvent:n.Events.removeEvent,removeAllEvents:n.Events.removeAllEvents,cleanName:function(q){var p,o;o=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(p=0;p<o.length;p+=2){q=q.replace(o[p],o[p+1])}q=q.replace(/\s+/g,"_");q=q.replace(/[^a-z0-9_\-\.]+/gi,"");return q},buildUrl:function(q,p){var o="";g.each(p,function(s,r){o+=(o?"&":"")+encodeURIComponent(r)+"="+encodeURIComponent(s)});if(o){q+=(q.indexOf("?")>0?"&":"?")+o}return q},formatSize:function(q){if(q===h||/\D/.test(q)){return g.translate("N/A")}function p(s,r){return Math.round(s*Math.pow(10,r))/Math.pow(10,r)}var o=Math.pow(1024,4);if(q>o){return p(q/o,1)+" "+g.translate("tb")}if(q>(o/=1024)){return p(q/o,1)+" "+g.translate("gb")}if(q>(o/=1024)){return p(q/o,1)+" "+g.translate("mb")}if(q>1024){return Math.round(q/1024)+" "+g.translate("kb")}return q+" "+g.translate("b")},parseSize:n.Basic.parseSizeStr,predictRuntime:function(s,p){var o,q;o=new g.Uploader(s);q=m.thatCan(o.getOption().required_features,p||s.runtimes);o.destroy();return q},addFileFilter:function(p,o){k[p]=o}};g.addFileFilter("mime_types",function(q,p,o){if(q.length&&!q.regexp.test(p.name)){this.trigger("Error",{code:g.FILE_EXTENSION_ERROR,message:g.translate("File extension error."),file:p});o(false)}else{o(true)}});g.addFileFilter("max_file_size",function(s,p,o){var q;s=g.parseSize(s);if(p.size!==q&&s&&p.size>s){this.trigger("Error",{code:g.FILE_SIZE_ERROR,message:g.translate("File size error."),file:p});o(false)}else{o(true)}});g.addFileFilter("prevent_duplicates",function(s,p,o){if(s){var q=this.files.length;while(q--){if(p.name===this.files[q].name&&p.size===this.files[q].size){this.trigger("Error",{code:g.FILE_DUPLICATE_ERROR,message:g.translate("Duplicate file error."),file:p});o(false);return}}}o(true)});g.addFileFilter("prevent_empty",function(q,p,o){if(q&&!p.size&&p.size!==h){this.trigger("Error",{code:g.FILE_SIZE_ERROR,message:g.translate("File size error."),file:p});o(false)}else{o(true)}});g.Uploader=function(X){var H=g.guid(),ab,F=[],U={},M=[],Q=[],J,N,W=false,P;function T(){var r,p=0,o;if(this.state==g.STARTED){for(o=0;o<F.length;o++){if(!r&&F[o].status==g.QUEUED){r=F[o];if(this.trigger("BeforeUpload",r)){r.status=g.UPLOADING;this.trigger("UploadFile",r)}}else{p++}}if(p==F.length){if(this.state!==g.STOPPED){this.state=g.STOPPED;this.trigger("StateChanged")}this.trigger("UploadComplete",F)}}}function K(o){o.percent=o.size>0?Math.ceil(o.loaded/o.size*100):100;Y()}function Y(){var u,p;var o;var s=0;N.reset();for(u=0;u<F.length;u++){p=F[u];if(p.size!==h){N.size+=p.origSize;o=p.loaded*p.origSize/p.size;if(!p.completeTimestamp||p.completeTimestamp>J){s+=o}N.loaded+=o}else{N.size=h}if(p.status==g.DONE){N.uploaded++}else{if(p.status==g.FAILED){N.failed++}else{N.queued++}}}if(N.size===h){N.percent=F.length>0?Math.ceil(N.uploaded/F.length*100):0}else{N.bytesPerSec=Math.ceil(s/((+new Date-J||1)/1000));N.percent=N.size>0?Math.ceil(N.loaded/N.size*100):0}}function Z(){var o=M[0]||Q[0];if(o){return o.getRuntime().uid}return false}function L(){this.bind("FilesAdded FilesRemoved",function(o){o.trigger("QueueChanged");o.refresh()});this.bind("CancelUpload",A);this.bind("BeforeUpload",G);this.bind("UploadFile",aa);this.bind("UploadProgress",B);this.bind("StateChanged",w);this.bind("QueueChanged",Y);this.bind("Error",q);this.bind("FileUploaded",x);this.bind("Destroy",C)}function V(v,y){var u=this,z=0,p=[];var o={runtime_order:v.runtimes,required_caps:v.required_features,preferred_caps:U,swf_url:v.flash_swf_url,xap_url:v.silverlight_xap_url};g.each(v.runtimes.split(/\s*,\s*/),function(r){if(v[r]){o[r]=v[r]}});if(v.browse_button){g.each(v.browse_button,function(e){p.push(function(r){var s=new l.file.FileInput(g.extend({},o,{accept:v.filters.mime_types,name:v.file_data_name,multiple:v.multi_selection,container:v.container,browse_button:e}));s.onready=function(){var t=m.getInfo(this.ruid);g.extend(u.features,{chunks:t.can("slice_blob"),multipart:t.can("send_multipart"),multi_selection:t.can("select_multiple")});z++;M.push(this);r()};s.onchange=function(){u.addFile(this.files)};s.bind("mouseenter mouseleave mousedown mouseup",function(t){if(!W){if(v.browse_button_hover){if("mouseenter"===t.type){g.addClass(e,v.browse_button_hover)}else{if("mouseleave"===t.type){g.removeClass(e,v.browse_button_hover)}}}if(v.browse_button_active){if("mousedown"===t.type){g.addClass(e,v.browse_button_active)}else{if("mouseup"===t.type){g.removeClass(e,v.browse_button_active)}}}}});s.bind("mousedown",function(){u.trigger("Browse")});s.bind("error runtimeerror",function(){s=null;r()});s.init()})})}if(v.drop_element){g.each(v.drop_element,function(e){p.push(function(r){var s=new l.file.FileDrop(g.extend({},o,{drop_zone:e}));s.onready=function(){var t=m.getInfo(this.ruid);g.extend(u.features,{chunks:t.can("slice_blob"),multipart:t.can("send_multipart"),dragdrop:t.can("drag_and_drop")});z++;Q.push(this);r()};s.ondrop=function(){u.addFile(this.files)};s.bind("error runtimeerror",function(){s=null;r()});s.init()})})}g.inSeries(p,function(){if(typeof y==="function"){y(z)}})}function ac(p,o,y,v){var u=new l.image.Image;try{u.onload=function(){if(o.width>this.width&&o.height>this.height&&o.quality===h&&o.preserve_headers&&!o.crop){this.destroy();v(p)}else{u.downsize(o.width,o.height,o.crop,o.preserve_headers)}};u.onresize=function(){var r=this.getAsBlob(p.type,o.quality);this.destroy();v(r)};u.bind("error runtimeerror",function(){this.destroy();v(p)});u.load(p,y)}catch(y){v(p)}}function D(y,p,o){var u=this,z=false;function v(O,E,s){var I=ab[O];switch(O){case"max_file_size":if(O==="max_file_size"){ab.max_file_size=ab.filters.max_file_size=E}break;case"chunk_size":if(E=g.parseSize(E)){ab[O]=E;ab.send_file_name=true}break;case"multipart":ab[O]=E;if(!E){ab.send_file_name=true}break;case"http_method":ab[O]=E.toUpperCase()==="PUT"?"PUT":"POST";break;case"unique_names":ab[O]=E;if(E){ab.send_file_name=true}break;case"filters":if(g.typeOf(E)==="array"){E={mime_types:E}}if(s){g.extend(ab.filters,E)}else{ab.filters=E}if(E.mime_types){if(g.typeOf(E.mime_types)==="string"){E.mime_types=l.core.utils.Mime.mimes2extList(E.mime_types)}E.mime_types.regexp=function(R){var r=[];g.each(R,function(t){g.each(t.extensions.split(/,/),function(S){if(/^\s*\*\s*$/.test(S)){r.push("\\.*")}else{r.push("\\."+S.replace(new RegExp("["+"/^$.*+?|()[]{}\\".replace(/./g,"\\$&")+"]","g"),"\\$&"))}})});return new RegExp("("+r.join("|")+")$","i")}(E.mime_types);ab.filters.mime_types=E.mime_types}break;case"resize":if(E){ab.resize=g.extend({preserve_headers:true,crop:false},E)}else{ab.resize=false}break;case"prevent_duplicates":ab.prevent_duplicates=ab.filters.prevent_duplicates=!!E;break;case"container":case"browse_button":case"drop_element":E="container"===O?g.get(E):g.getAll(E);case"runtimes":case"multi_selection":case"flash_swf_url":case"silverlight_xap_url":ab[O]=E;if(!s){z=true}break;default:ab[O]=E}if(!s){u.trigger("OptionChanged",O,E,I)}}if(typeof y==="object"){g.each(y,function(s,r){v(r,s,o)})}else{v(y,p,o)}if(o){ab.required_features=i(g.extend({},ab));U=i(g.extend({},ab,{required_features:true}))}else{if(z){u.trigger("Destroy");V.call(u,ab,function(r){if(r){u.runtime=m.getInfo(Z()).type;u.trigger("Init",{runtime:u.runtime});u.trigger("PostInit")}else{u.trigger("Error",{code:g.INIT_ERROR,message:g.translate("Init error.")})}})}}}function G(u,p){if(u.settings.unique_names){var o=p.name.match(/\.([^.]+)$/),s="part";if(o){s=o[1]}p.target_name=p.id+"."+s}}function aa(ae,y){var S=ae.settings.url;var e=ae.settings.chunk_size;var v=ae.settings.max_retries;var z=ae.features;var ad=0;var I;var O={runtime_order:ae.settings.runtimes,required_caps:ae.settings.required_features,preferred_caps:U,swf_url:ae.settings.flash_swf_url,xap_url:ae.settings.silverlight_xap_url};if(y.loaded){ad=y.loaded=e?e*Math.floor(y.loaded/e):0}function R(){if(v-->0){f(t,1000)}else{y.loaded=ad;ae.trigger("Error",{code:g.HTTP_ERROR,message:g.translate("HTTP Error."),file:y,response:P.responseText,status:P.status,responseHeaders:P.getAllResponseHeaders()})}}function t(){var r,p={},o;if(y.status!==g.UPLOADING||ae.state===g.STOPPED){return}if(ae.settings.send_file_name){p.name=y.target_name||y.name}if(e&&z.chunks&&I.size>e){o=Math.min(e,I.size-ad);r=I.slice(ad,ad+o)}else{o=I.size;r=I}if(e&&z.chunks){if(ae.settings.send_chunk_number){p.chunk=Math.ceil(ad/e);p.chunks=Math.ceil(I.size/e)}else{p.offset=ad;p.total=I.size}}if(ae.trigger("BeforeChunkUpload",y,p,r,ad)){E(p,r,o)}}function E(u,p,o){var s;P=new l.xhr.XMLHttpRequest;if(P.upload){P.upload.onprogress=function(r){y.loaded=Math.min(y.size,ad+r.loaded);ae.trigger("UploadProgress",y)}}P.onload=function(){if(P.status<200||P.status>=400){R();return}v=ae.settings.max_retries;if(o<I.size){p.destroy();ad+=o;y.loaded=Math.min(ad,I.size);ae.trigger("ChunkUploaded",y,{offset:y.loaded,total:I.size,response:P.responseText,status:P.status,responseHeaders:P.getAllResponseHeaders()});if(g.ua.browser==="Android Browser"){ae.trigger("UploadProgress",y)}}else{y.loaded=y.size}p=s=null;if(!ad||ad>=I.size){if(y.size!=y.origSize){I.destroy();I=null}ae.trigger("UploadProgress",y);y.status=g.DONE;y.completeTimestamp=+new Date;ae.trigger("FileUploaded",y,{response:P.responseText,status:P.status,responseHeaders:P.getAllResponseHeaders()})}else{f(t,1)}};P.onerror=function(){R()};P.onloadend=function(){this.destroy()};if(ae.settings.multipart&&z.multipart){P.open(ae.settings.http_method,S,true);g.each(ae.settings.headers,function(af,r){P.setRequestHeader(r,af)});s=new l.xhr.FormData;g.each(g.extend(u,ae.settings.multipart_params),function(af,r){s.append(r,af)});s.append(ae.settings.file_data_name,p);P.send(s,O)}else{S=g.buildUrl(ae.settings.url,g.extend(u,ae.settings.multipart_params));P.open(ae.settings.http_method,S,true);g.each(ae.settings.headers,function(af,r){P.setRequestHeader(r,af)});if(!P.hasRequestHeader("Content-Type")){P.setRequestHeader("Content-Type","application/octet-stream")}P.send(p,O)}}I=y.getSource();if(!g.isEmptyObj(ae.settings.resize)&&g.inArray(I.type,["image/jpeg","image/png"])!==-1){ac(I,ae.settings.resize,O,function(o){I=o;y.size=o.size;t()})}else{t()}}function B(p,o){K(o)}function w(p){if(p.state==g.STARTED){J=+new Date}else{if(p.state==g.STOPPED){for(var o=p.files.length-1;o>=0;o--){if(p.files[o].status==g.UPLOADING){p.files[o].status=g.QUEUED;Y()}}}}}function A(){if(P){P.abort()}}function x(o){Y();f(function(){T.call(o)},1)}function q(p,o){if(o.code===g.INIT_ERROR){p.destroy()}else{if(o.code===g.HTTP_ERROR){o.file.status=g.FAILED;o.file.completeTimestamp=+new Date;K(o.file);if(p.state==g.STARTED){p.trigger("CancelUpload");f(function(){T.call(p)},1)}}}}function C(o){o.stop();g.each(F,function(p){p.destroy()});F=[];if(M.length){g.each(M,function(p){p.destroy()});M=[]}if(Q.length){g.each(Q,function(p){p.destroy()});Q=[]}U={};W=false;J=P=null;N.reset()}ab={chunk_size:0,file_data_name:"file",filters:{mime_types:[],max_file_size:0,prevent_duplicates:false,prevent_empty:true},flash_swf_url:"js/Moxie.swf",http_method:"POST",max_retries:0,multipart:true,multi_selection:true,resize:false,runtimes:m.order,send_file_name:true,send_chunk_number:true,silverlight_xap_url:"js/Moxie.xap"};D.call(this,X,null,true);N=new g.QueueProgress;g.extend(this,{id:H,uid:H,state:g.STOPPED,features:{},runtime:null,files:F,settings:ab,total:N,init:function(){var p=this,u,o,s;o=p.getOption("preinit");if(typeof o=="function"){o(p)}else{g.each(o,function(v,r){p.bind(r,v)})}L.call(p);g.each(["container","browse_button","drop_element"],function(r){if(p.getOption(r)===null){s={code:g.INIT_ERROR,message:g.sprintf(g.translate("%s specified, but cannot be found."),r)};return false}});if(s){return p.trigger("Error",s)}if(!ab.browse_button&&!ab.drop_element){return p.trigger("Error",{code:g.INIT_ERROR,message:g.translate("You must specify either browse_button or drop_element.")})}V.call(p,ab,function(v){var r=p.getOption("init");if(typeof r=="function"){r(p)}else{g.each(r,function(z,y){p.bind(y,z)})}if(v){p.runtime=m.getInfo(Z()).type;p.trigger("Init",{runtime:p.runtime});p.trigger("PostInit")}else{p.trigger("Error",{code:g.INIT_ERROR,message:g.translate("Init error.")})}})},setOption:function(p,o){D.call(this,p,o,!this.runtime)},getOption:function(o){if(!o){return ab}return ab[o]},refresh:function(){if(M.length){g.each(M,function(o){o.trigger("Refresh")})}this.trigger("Refresh")},start:function(){if(this.state!=g.STARTED){this.state=g.STARTED;this.trigger("StateChanged");T.call(this)}},stop:function(){if(this.state!=g.STOPPED){this.state=g.STOPPED;this.trigger("StateChanged");this.trigger("CancelUpload")}},disableBrowse:function(){W=arguments[0]!==h?arguments[0]:true;if(M.length){g.each(M,function(o){o.disable(W)})}this.trigger("DisableBrowse",W)},getFile:function(p){var o;for(o=F.length-1;o>=0;o--){if(F[o].id===p){return F[o]}}},addFile:function(E,v){var y=this,z=[],O=[],u;function I(s,R){var o=[];g.each(y.settings.filters,function(t,r){if(k[r]){o.push(function(e){k[r].call(y,t,s,function(S){e(!S)})})}});g.inSeries(o,R)}function p(o){var r=g.typeOf(o);if(o instanceof l.file.File){if(!o.ruid&&!o.isDetached()){if(!u){return false}o.ruid=u;o.connectRuntime(u)}p(new g.File(o))}else{if(o instanceof l.file.Blob){p(o.getSource());o.destroy()}else{if(o instanceof g.File){if(v){o.name=v}z.push(function(e){I(o,function(s){if(!s){F.push(o);O.push(o);y.trigger("FileFiltered",o)}f(e,1)})})}else{if(g.inArray(r,["file","blob"])!==-1){p(new l.file.File(null,o))}else{if(r==="node"&&g.typeOf(o.files)==="filelist"){g.each(o.files,p)}else{if(r==="array"){v=null;g.each(o,p)}}}}}}}u=Z();p(E);if(z.length){g.inSeries(z,function(){if(O.length){y.trigger("FilesAdded",O)}})}},removeFile:function(r){var p=typeof r==="string"?r:r.id;for(var o=F.length-1;o>=0;o--){if(F[o].id===p){return this.splice(o,1)[0]}}},splice:function(u,p){var o=F.splice(u===h?0:u,p===h?F.length:p);var s=false;if(this.state==g.STARTED){g.each(o,function(r){if(r.status===g.UPLOADING){s=true;return false}});if(s){this.stop()}}this.trigger("FilesRemoved",o);g.each(o,function(r){r.destroy()});if(s){this.start()}return o},dispatchEvent:function(y){var p,o,v;y=y.toLowerCase();p=this.hasEventListener(y);if(p){p.sort(function(s,r){return r.priority-s.priority});o=[].slice.call(arguments);o.shift();o.unshift(this);for(var u=0;u<p.length;u++){if(p[u].fn.apply(p[u].scope,o)===false){return false}}}return true},bind:function(u,p,o,s){g.Uploader.prototype.bind.call(this,u,p,s,o)},destroy:function(){this.trigger("Destroy");ab=N=null;this.unbindAll()}})};g.Uploader.prototype=l.core.EventTarget.instance;g.File=function(){var o={};function p(q){g.extend(this,{id:g.guid(),name:q.name||q.fileName,type:q.type||"",relativePath:q.relativePath||"",size:q.fileSize||q.size,origSize:q.fileSize||q.size,loaded:0,percent:0,status:g.QUEUED,lastModifiedDate:q.lastModifiedDate||(new Date).toLocaleString(),completeTimestamp:0,getNative:function(){var r=this.getSource().getSource();return g.inArray(g.typeOf(r),["blob","file"])!==-1?r:null},getSource:function(){if(!o[this.id]){return null}return o[this.id]},destroy:function(){var r=this.getSource();if(r){r.destroy();delete o[this.id]}}});o[this.id]=q}return p}();g.QueueProgress=function(){var o=this;o.size=0;o.loaded=0;o.uploaded=0;o.failed=0;o.queued=0;o.percent=0;o.bytesPerSec=0;o.reset=function(){o.size=o.loaded=o.uploaded=o.failed=o.queued=o.percent=o.bytesPerSec=0}};j.plupload=g})(this,d)}.apply(c,arguments),c.plupload}"function"==typeof define&&define.amd?define("plupload",["./moxie"],a):"object"==typeof module&&module.exports?module.exports=a(require("./moxie")):b.plupload=a(b.moxie)}(this||window);